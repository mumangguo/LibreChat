# LibreChat è®°å¿†ä¸ä¸Šä¸‹æ–‡æœºåˆ¶åˆ†æ

## 1. æ€»ä½“æ¦‚è§ˆ
LibreChat å°†å¯¹è¯åˆ†æˆâ€œçŸ­æœŸä¸Šä¸‹æ–‡â€å’Œâ€œé•¿æœŸè®°å¿†â€ä¸¤å±‚ï¼š
- **çŸ­æœŸä¸Šä¸‹æ–‡**ï¼šå½“å‰ä¼šè¯ä¸­å°šæœªè¢«æˆªæ–­çš„æ¶ˆæ¯ã€ç³»ç»ŸæŒ‡ä»¤ä»¥åŠå·¥å…·ç»“æœã€‚æ¯æ¬¡è°ƒç”¨æ¨¡å‹å‰éƒ½ä¼šæ ¹æ® token é™é¢é‡æ’/è£å‰ªã€‚
- **é•¿æœŸè®°å¿†**ï¼šå¯é€‰ç‰¹æ€§ã€‚è‹¥å¼€å¯ï¼Œä¼šåœ¨è°ƒç”¨æ¨¡å‹å‰æ£€ç´¢å†å²è®°å¿†å¹¶å†™å…¥ç³»ç»Ÿæç¤ºï¼Œåœ¨æ¨¡å‹å›å¤åè¿˜å¯æŠŠæ–°äº‹å®å†™å›è®°å¿†åº“ã€‚
- **å¤–éƒ¨ä¸Šä¸‹æ–‡**ï¼šæ–‡ä»¶æ£€ç´¢ã€Web/MCP å·¥å…·ç­‰æä¾›å®æ—¶æ•°æ®ï¼›å®ƒä»¬é»˜è®¤åªå½±å“æœ¬è½®å¯¹è¯ï¼Œä¸è‡ªåŠ¨è½åº“ã€‚

## 2. çŸ­æœŸä¸Šä¸‹æ–‡ï¼ˆå³æ—¶å¯¹è¯çª—å£ï¼‰
`AgentClient.buildMessages()` è´Ÿè´£æŠŠå½“å‰ä¼šè¯æ•´ç†æˆæ¨¡å‹å¯æ¶ˆè´¹çš„æ¶ˆæ¯ï¼šå…ˆæ’åºæ¶ˆæ¯ã€æ‰§è¡Œ `handleContextStrategy` å†³å®šçª—å£ï¼Œå†ç”Ÿæˆ `payload`ã€‚å…¶åå†è¿½åŠ è®°å¿†ï¼ˆè‹¥æœ‰ï¼‰ã€‚

```436:474:api/server/controllers/agents/client.js
    if (this.contextStrategy) {
      ({ payload, promptTokens, tokenCountMap, messages } = await this.handleContextStrategy({
        orderedMessages,
        formattedMessages,
      }));
    }
    ...
    const result = {
      tokenCountMap,
      prompt: payload,
      promptTokens,
      messages,
    };
    ...
    const withoutKeys = await this.useMemory();
    if (withoutKeys) {
      systemContent += `${memoryInstructions}\n\n# Existing memory about the user:\n${withoutKeys}`;
    }
```

è‹¥è¦è‡ªå®šä¹‰çŸ­æœŸä¸Šä¸‹æ–‡ï¼Œå¯å®ç°æ–°çš„ `contextStrategy`ï¼ˆå¦‚æŒ‰è§’è‰²è¿‡æ»¤ã€æŒ‰ä¸»é¢˜èšç±»ï¼‰å¹¶åœ¨ Agent åˆå§‹åŒ–æ—¶æ³¨å…¥ã€‚

## 3. é•¿æœŸè®°å¿†ï¼ˆMemory Serviceï¼‰

### 3.0 æ ¸å¿ƒå®ç°æœºåˆ¶æ·±åº¦åˆ†æ

#### 3.0.1 ä¸ºä»€ä¹ˆé…ç½®è®°å¿† Agent åå¯ä»¥è‡ªåŠ¨æå–ç”¨æˆ·ç‰¹å¾ï¼Ÿ

**æ ¸å¿ƒåŸç†ï¼š**
é…ç½® `memory.agent` åï¼Œç³»ç»Ÿä¼šåˆ›å»ºä¸€ä¸ª**ç‹¬ç«‹çš„è®°å¿†ç®¡ç† Agent**ï¼Œè¯¥ Agent ä½¿ç”¨ LLM çš„èƒ½åŠ›æ¥ç†è§£å¯¹è¯å†…å®¹ï¼Œå¹¶é€šè¿‡**å·¥å…·è°ƒç”¨æœºåˆ¶**è‡ªåŠ¨æå–å’Œå­˜å‚¨ç”¨æˆ·ç‰¹å¾ã€‚æ•´ä¸ªè¿‡ç¨‹åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼š**è®°å¿†è¯»å–ï¼ˆåµŒå…¥ä¸Šä¸‹æ–‡ï¼‰**å’Œ**è®°å¿†å†™å…¥ï¼ˆç‰¹å¾æå–ï¼‰**ã€‚

#### 3.0.2 è®°å¿†å¦‚ä½•åµŒå…¥åˆ°ä¸Šä¸‹æ–‡ï¼Ÿ

**æµç¨‹è¯¦è§£ï¼š**

1. **åœ¨ `buildMessages()` é˜¶æ®µè°ƒç”¨ `useMemory()`**ï¼š
   ```javascript
   // api/server/controllers/agents/client.js:465-468
   const withoutKeys = await this.useMemory();
   if (withoutKeys) {
     systemContent += `${memoryInstructions}\n\n# Existing memory about the user:\n${withoutKeys}`;
   }
   ```

2. **`useMemory()` å†…éƒ¨æ‰§è¡Œæµç¨‹**ï¼š
   ```javascript
   // api/server/controllers/agents/client.js:516-621
   async useMemory() {
     // 1. æƒé™å’Œé…ç½®æ£€æŸ¥
     // 2. åŠ è½½è®°å¿† Agent é…ç½®ï¼ˆä» config.yaml çš„ memory.agentï¼‰
     // 3. è°ƒç”¨ createMemoryProcessor
     const [withoutKeys, processMemory] = await createMemoryProcessor({
       userId, config, messageId, conversationId,
       memoryMethods: { setMemory, deleteMemory, getFormattedMemories },
       res: this.options.res,
     });
     this.processMemory = processMemory;  // ä¿å­˜ä¾›åç»­ä½¿ç”¨
     return withoutKeys;  // è¿”å›æ ¼å¼åŒ–åçš„è®°å¿†æ–‡æœ¬
   }
   ```

3. **`createMemoryProcessor()` æ ¼å¼åŒ–è®°å¿†**ï¼š
   ```typescript
   // packages/api/src/agents/memory.ts:412-458
   export async function createMemoryProcessor({...}) {
     // 1. è·å–ç”¨æˆ·çš„æ‰€æœ‰è®°å¿†
     const { withKeys, withoutKeys, totalTokens } = 
       await memoryMethods.getFormattedMemories({ userId });
     
     // 2. è¿”å›ä¸¤ä¸ªå€¼ï¼š
     //    - withoutKeys: ç”¨äºæ³¨å…¥åˆ°ç³»ç»Ÿæç¤ºï¼ˆä¸åŒ…å«keyï¼Œåªæ˜¾ç¤ºvalueï¼‰
     //    - processMemory: ç”¨äºåç»­å†™å…¥è®°å¿†çš„å‡½æ•°
     return [withoutKeys, async function (messages) { ... }];
   }
   ```

4. **`getFormattedMemories()` æ ¼å¼åŒ–é€»è¾‘**ï¼š
   ```typescript
   // packages/data-schemas/src/methods/memory.ts:121-159
   async function getFormattedMemories({ userId }) {
     const memories = await getAllUserMemories(userId);
     
     // withoutKeys æ ¼å¼ï¼šç”¨äºæ³¨å…¥ç³»ç»Ÿæç¤ºï¼ˆç®€æ´ç‰ˆï¼‰
     const withoutKeys = sortedMemories
       .map((memory, index) => {
         const date = formatDate(new Date(memory.updated_at!));
         return `${index + 1}. [${date}]. ${memory.value}`;
       })
       .join('\n\n');
     
     // withKeys æ ¼å¼ï¼šç”¨äºä¼ é€’ç»™è®°å¿† Agentï¼ˆåŒ…å«keyå’Œtokenä¿¡æ¯ï¼‰
     const withKeys = sortedMemories
       .map((memory, index) => {
         const date = formatDate(new Date(memory.updated_at!));
         const tokenInfo = memory.tokenCount ? ` [${memory.tokenCount} tokens]` : '';
         return `${index + 1}. [${date}]. ["key": "${memory.key}"]${tokenInfo}. ["value": "${memory.value}"]`;
       })
       .join('\n\n');
     
     return { withKeys, withoutKeys, totalTokens };
   }
   ```

5. **æœ€ç»ˆæ³¨å…¥åˆ°ç³»ç»Ÿæç¤º**ï¼š
   - `withoutKeys` è¢«è¿½åŠ åˆ° `systemContent` ä¸­
   - æ ¼å¼ç¤ºä¾‹ï¼š
     ```
     The system automatically stores important user information...
     
     # Existing memory about the user:
     1. [2024-01-15]. ç”¨æˆ·æ˜¯ä¸€åè½¯ä»¶å·¥ç¨‹å¸ˆï¼Œæ“…é•¿ Python å’Œ JavaScript
     2. [2024-01-16]. ç”¨æˆ·å–œæ¬¢å–å’–å•¡ï¼Œé€šå¸¸åœ¨æ—©ä¸Š 9 ç‚¹å¼€å§‹å·¥ä½œ
     ```
   - è¿™æ ·ï¼Œæ¯æ¬¡å¯¹è¯æ—¶ï¼Œä¸» Agent éƒ½èƒ½çœ‹åˆ°ç”¨æˆ·çš„å†å²è®°å¿†

#### 3.0.3 Agent å¦‚ä½•å¯¹ç”¨æˆ·æé—®è¿›è¡Œæ€»ç»“å½’çº³å‡ºç‰¹å¾ï¼Ÿ

**æ ¸å¿ƒæœºåˆ¶ï¼šå·¥å…·è°ƒç”¨ï¼ˆTool Callingï¼‰**

1. **è§¦å‘æ—¶æœº**ï¼š
   ```javascript
   // api/server/controllers/agents/client.js:953
   // åœ¨ AI å›å¤å®Œæˆåï¼Œè‡ªåŠ¨è°ƒç”¨
   memoryPromise = this.runMemory(messages);
   ```

2. **æ¶ˆæ¯çª—å£é€‰æ‹©**ï¼š
   ```javascript
   // api/server/controllers/agents/client.js:660-691
   async runMemory(messages) {
     const messageWindowSize = memoryConfig?.messageWindowSize ?? 5;
     
     // é€‰æ‹©æœ€è¿‘çš„æ¶ˆæ¯çª—å£ï¼ˆé»˜è®¤5æ¡ï¼‰
     // ä¼˜å…ˆé€‰æ‹©ä»¥ç”¨æˆ·æ¶ˆæ¯å¼€å¤´çš„çª—å£
     let messagesToProcess = [...messages];
     if (messages.length > messageWindowSize) {
       for (let i = messages.length - messageWindowSize; i >= 0; i--) {
         const potentialWindow = messages.slice(i, i + messageWindowSize);
         if (potentialWindow[0]?.role === 'user') {
           messagesToProcess = [...potentialWindow];
           break;
         }
       }
     }
     
     // è¿‡æ»¤å›¾ç‰‡URLï¼Œè½¬æ¢ä¸ºæ–‡æœ¬æ ¼å¼
     const filteredMessages = messagesToProcess.map((msg) => this.filterImageUrls(msg));
     const bufferString = getBufferString(filteredMessages);
     const bufferMessage = new HumanMessage(`# Current Chat:\n\n${bufferString}`);
     
     // ä¼ é€’ç»™è®°å¿† Agent å¤„ç†
     return await this.processMemory([bufferMessage]);
   }
   ```

3. **åˆ›å»ºç‹¬ç«‹çš„è®°å¿† Agent**ï¼š
   ```typescript
   // packages/api/src/agents/memory.ts:271-410
   export async function processMemory({...}) {
     // 1. åˆ›å»ºè®°å¿†å·¥å…·ï¼ˆset_memory å’Œ delete_memoryï¼‰
     const memoryTool = createMemoryTool({
       userId, tokenLimit, setMemory, validKeys, totalTokens,
     });
     const deleteMemoryTool = createDeleteMemoryTool({
       userId, validKeys, deleteMemory,
     });
     
     // 2. å‡†å¤‡è®°å¿†çŠ¶æ€ä¿¡æ¯ï¼ˆåŒ…å«ç°æœ‰è®°å¿†å’Œtokenä½¿ç”¨æƒ…å†µï¼‰
     let memoryStatus = `# Existing memory:\n${memory ?? 'No existing memories'}`;
     if (tokenLimit) {
       memoryStatus = `# Memory Status:
       Current memory usage: ${currentMemoryTokens} tokens
       Token limit: ${tokenLimit} tokens
       Remaining capacity: ${remainingTokens} tokens
       
       # Existing memory:
       ${memory ?? 'No existing memories'}`;
     }
     
     // 3. åˆ›å»º Run å®ä¾‹ï¼ˆç‹¬ç«‹çš„ Agent æ‰§è¡Œç¯å¢ƒï¼‰
     const run = await Run.create({
       runId: messageId,
       graphConfig: {
         type: 'standard',
         llmConfig: finalLLMConfig,  // ä½¿ç”¨é…ç½®çš„æ¨¡å‹ï¼ˆå¦‚ Deepseekï¼‰
         tools: [memoryTool, deleteMemoryTool],  // æä¾›å·¥å…·
         instructions,  // ä½¿ç”¨é…ç½®çš„ instructionsï¼ˆå…³é”®ï¼ï¼‰
         additional_instructions: memoryStatus,  // ç°æœ‰è®°å¿†çŠ¶æ€
         toolEnd: true,
       },
       customHandlers: {
         [GraphEvents.TOOL_END]: new BasicToolEndHandler(memoryCallback),
       },
       returnContent: true,
     });
     
     // 4. æ‰§è¡Œ Agentï¼Œä¼ å…¥å½“å‰å¯¹è¯çª—å£
     const inputs = { messages };
     const content = await run.processStream(inputs, config);
   }
   ```

4. **Agent åˆ†ææµç¨‹**ï¼š
   - **è¾“å…¥**ï¼šå½“å‰å¯¹è¯çª—å£ï¼ˆæœ€è¿‘5æ¡æ¶ˆæ¯ï¼‰+ ç°æœ‰è®°å¿†çŠ¶æ€ + é…ç½®çš„ instructions
   - **å¤„ç†**ï¼šLLMï¼ˆå¦‚ Deepseekï¼‰æ ¹æ® `instructions` åˆ†æå¯¹è¯å†…å®¹
   - **è¾“å‡º**ï¼šAgent å†³å®šæ˜¯å¦è°ƒç”¨ `set_memory` æˆ– `delete_memory` å·¥å…·

5. **å·¥å…·è°ƒç”¨æœºåˆ¶**ï¼š
   ```typescript
   // packages/api/src/agents/memory.ts:76-186
   export const createMemoryTool = ({ userId, setMemory, validKeys, tokenLimit, totalTokens }) => {
     return tool(
       async ({ key, value }) => {
         // 1. éªŒè¯ key æ˜¯å¦åœ¨ validKeys åˆ—è¡¨ä¸­
         if (validKeys && validKeys.length > 0 && !validKeys.includes(key)) {
           return [`Invalid key "${key}"...`, undefined];
         }
         
         // 2. è®¡ç®— token æ•°é‡
         const tokenCount = Tokenizer.getTokenCount(value, 'o200k_base');
         
         // 3. æ£€æŸ¥ token é™åˆ¶
         if (tokenLimit) {
           const newTotalTokens = totalTokens + tokenCount;
           if (newTotalTokens > tokenLimit) {
             return [`Memory storage would exceed limit...`, errorArtifact];
           }
         }
         
         // 4. è°ƒç”¨ setMemory å†™å…¥æ•°æ®åº“
         const result = await setMemory({ userId, key, value, tokenCount });
         if (result.ok) {
           return [`Memory set for key "${key}" (${tokenCount} tokens)`, artifact];
         }
       },
       {
         name: 'set_memory',
         description: 'Saves important information about the user into memory.',
         schema: z.object({
           key: z.string().describe('The key identifier for this memory'),
           value: z.string().describe('Value MUST be a complete sentence...'),
         }),
       },
     );
   };
   ```

6. **æ•°æ®åº“å­˜å‚¨**ï¼š
   ```typescript
   // packages/data-schemas/src/methods/memory.ts:54-85
   async function setMemory({ userId, key, value, tokenCount = 0 }) {
     const MemoryEntry = mongoose.models.MemoryEntry;
     // ä½¿ç”¨ upsertï¼šå¦‚æœå­˜åœ¨åˆ™æ›´æ–°ï¼Œä¸å­˜åœ¨åˆ™åˆ›å»º
     await MemoryEntry.findOneAndUpdate(
       { userId, key },
       { value, tokenCount, updated_at: new Date() },
       { upsert: true, new: true }
     );
     return { ok: true };
   }
   ```

#### 3.0.4 ä¸ºä»€ä¹ˆè‡ªå®šä¹‰ instructions å¯ä»¥æ”¹å˜å­˜å‚¨ç­–ç•¥ï¼Ÿ

**å…³é”®ç‚¹ï¼šinstructions ç›´æ¥æ§åˆ¶ Agent çš„è¡Œä¸º**

1. **é»˜è®¤ instructionsï¼ˆæŒ‰éœ€å­˜å‚¨ï¼‰**ï¼š
   ```typescript
   // packages/api/src/agents/memory.ts:42-71
   const getDefaultInstructions = (validKeys?, tokenLimit?) => `
   Use the \`set_memory\` tool to save important information about the user, 
   but ONLY when the user has requested you to remember something.
   
   1. ONLY use memory tools when the user requests memory actions...
   2. NEVER store information just because the user mentioned it...
   5. If the user doesn't ask you to remember or forget something, 
      DO NOT use any memory tools.
   `;
   ```
   - è¿™ç§ instructions è¦æ±‚ Agent **åªåœ¨ç”¨æˆ·æ˜ç¡®è¯·æ±‚æ—¶**æ‰å­˜å‚¨

2. **è‡ªå®šä¹‰ instructionsï¼ˆä¸»åŠ¨å­˜å‚¨ï¼‰**ï¼š
   ```yaml
   # config.yaml:485-497
   instructions: |
     ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½è®°å¿†ç®¡ç†åŠ©æ‰‹ã€‚åˆ†æå¯¹è¯å†…å®¹ï¼Œè‡ªåŠ¨æå–å¹¶å­˜å‚¨ä»¥ä¸‹ç±»å‹çš„é‡è¦ä¿¡æ¯ï¼š
     1. ç”¨æˆ·çš„èº«ä»½ä¿¡æ¯ï¼ˆå§“åã€æ˜µç§°ã€èŒä¸šã€è§’è‰²ç­‰ï¼‰
     2. ç”¨æˆ·çš„åå¥½å’Œä¹ æƒ¯ï¼ˆå–œæ¬¢ä»€ä¹ˆã€ä¸å–œæ¬¢ä»€ä¹ˆã€å¸¸ç”¨æ–¹å¼ç­‰ï¼‰
     3. ç”¨æˆ·çš„å·¥ä½œå’Œå­¦ä¹ ä¿¡æ¯ï¼ˆå·¥ä½œå†…å®¹ã€å­¦ä¹ ç›®æ ‡ã€é¡¹ç›®ç­‰ï¼‰
     4. ç”¨æˆ·çš„æŠ€èƒ½å’Œå…´è¶£ï¼ˆæ“…é•¿ä»€ä¹ˆã€å…´è¶£çˆ±å¥½ç­‰ï¼‰
     5. å¯¹è¯ä¸­çš„é‡è¦ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ˆé‡è¦äº‹ä»¶ã€å…³ç³»ã€èƒŒæ™¯ç­‰ï¼‰
     
     ä½¿ç”¨ set_memory å·¥å…·è‡ªåŠ¨å­˜å‚¨è¿™äº›ä¿¡æ¯ï¼Œä½¿ç”¨åˆé€‚çš„ key...
     ä¸»åŠ¨è¯†åˆ«å¹¶å­˜å‚¨é‡è¦ä¿¡æ¯ï¼Œä¸è¦ç­‰å¾…ç”¨æˆ·æ˜ç¡®è¯·æ±‚ã€‚
   ```
   - è¿™ç§ instructions è¦æ±‚ Agent **ä¸»åŠ¨è¯†åˆ«å¹¶å­˜å‚¨**é‡è¦ä¿¡æ¯

3. **instructions å¦‚ä½•ç”Ÿæ•ˆ**ï¼š
   ```typescript
   // packages/api/src/agents/memory.ts:427-428
   const finalInstructions = instructions || getDefaultInstructions(validKeys, tokenLimit);
   
   // ä¼ é€’ç»™ Run.create
   graphConfig: {
     instructions: finalInstructions,  // ä½œä¸ºç³»ç»Ÿæç¤ºçš„ä¸€éƒ¨åˆ†
     ...
   }
   ```
   - `instructions` ä½œä¸ºç³»ç»Ÿæç¤ºä¼ é€’ç»™ LLM
   - LLM æ ¹æ®è¿™äº›æŒ‡ä»¤æ¥å†³å®šæ˜¯å¦è°ƒç”¨å·¥å…·
   - ä¸åŒçš„ instructions ä¼šå¯¼è‡´ä¸åŒçš„è¡Œä¸ºæ¨¡å¼

#### 3.0.5 å®Œæ•´æ‰§è¡Œæµç¨‹å›¾

```
ç”¨æˆ·å‘é€æ¶ˆæ¯
    â†“
AgentClient.buildMessages()
    â†“
useMemory() è¢«è°ƒç”¨
    â†“
createMemoryProcessor()
    â”œâ”€â†’ getFormattedMemories() â†’ ä»æ•°æ®åº“è¯»å–å†å²è®°å¿†
    â”œâ”€â†’ è¿”å› withoutKeysï¼ˆæ ¼å¼åŒ–æ–‡æœ¬ï¼‰
    â””â”€â†’ è¿”å› processMemory å‡½æ•°ï¼ˆä¿å­˜åˆ° this.processMemoryï¼‰
    â†“
withoutKeys æ³¨å…¥åˆ° systemContent
    â†“
ä¸» Agent ç”Ÿæˆå›å¤
    â†“
å›å¤å®Œæˆåï¼ŒrunMemory(messages) è¢«è°ƒç”¨
    â†“
é€‰æ‹©æ¶ˆæ¯çª—å£ï¼ˆæœ€è¿‘5æ¡ï¼‰
    â†“
processMemory() è¢«è°ƒç”¨
    â”œâ”€â†’ åˆ›å»º set_memory å’Œ delete_memory å·¥å…·
    â”œâ”€â†’ å‡†å¤‡è®°å¿†çŠ¶æ€ï¼ˆç°æœ‰è®°å¿† + token ä½¿ç”¨æƒ…å†µï¼‰
    â”œâ”€â†’ åˆ›å»º Run å®ä¾‹ï¼ˆç‹¬ç«‹çš„è®°å¿† Agentï¼‰
    â”‚   â”œâ”€â†’ ä½¿ç”¨é…ç½®çš„æ¨¡å‹ï¼ˆå¦‚ Deepseekï¼‰
    â”‚   â”œâ”€â†’ ä½¿ç”¨é…ç½®çš„ instructionsï¼ˆå…³é”®ï¼ï¼‰
    â”‚   â”œâ”€â†’ æä¾›å·¥å…·ï¼ˆset_memory, delete_memoryï¼‰
    â”‚   â””â”€â†’ ä¼ å…¥ç°æœ‰è®°å¿†çŠ¶æ€
    â””â”€â†’ run.processStream({ messages: [å½“å‰å¯¹è¯çª—å£] })
        â†“
    è®°å¿† Agent åˆ†æå¯¹è¯
        â”œâ”€â†’ æ ¹æ® instructions åˆ¤æ–­æ˜¯å¦éœ€è¦å­˜å‚¨
        â”œâ”€â†’ å¦‚æœéœ€è¦ï¼Œè°ƒç”¨ set_memory({ key, value })
        â””â”€â†’ å·¥å…·æ‰§è¡Œ â†’ setMemory() â†’ å†™å…¥ MongoDB
            â†“
        ä¸‹æ¬¡å¯¹è¯æ—¶ï¼Œæ–°è®°å¿†ä¼šè¢«è‡ªåŠ¨è¯»å–å¹¶æ³¨å…¥
```

### 3.1 è®°å¿†è¯»å–ï¼ˆè‡ªåŠ¨ï¼‰
å½“é…ç½®å¼€å¯ä¸”ç”¨æˆ·æœ‰ `Permissions.MEMORIES` æƒé™æ—¶ï¼Œ`useMemory()` ä¼šï¼š
1. æ ¡éªŒç”¨æˆ·ä¸é…ç½®ï¼Œå†³å®šæ˜¯å¦å¯ç”¨è®°å¿†ã€‚
2. æ ¹æ® `appConfig.memory.agent` åŠ è½½ä¸“ç”¨ Agentï¼Œæ„é€ è®°å¿†æ‰€ç”¨æ¨¡å‹ä¸æç¤ºè¯ã€‚
3. è°ƒç”¨ `createMemoryProcessor` å¾—åˆ° `withoutKeys`ï¼ˆæ³¨å…¥ç³»ç»Ÿæç¤ºçš„æ–‡æœ¬ï¼‰å’Œ `processMemory`ï¼ˆåç»­å†™å›ï¼‰ã€‚

```513:618:api/server/controllers/agents/client.js
  async useMemory() {
    const user = this.options.req.user;
    if (user.personalization?.memories === false) {
      return;
    }
    const hasAccess = await checkAccess({
      user,
      permissionType: PermissionTypes.MEMORIES,
      permissions: [Permissions.USE],
      getRoleByName,
    });
    if (!hasAccess) {
      return;
    }
    const appConfig = this.options.req.config;
    const memoryConfig = appConfig.memory;
    if (!memoryConfig || memoryConfig.disabled === true) {
      return;
    }
    ...
    const [withoutKeys, processMemory] = await createMemoryProcessor({
      userId,
      config,
      messageId,
      conversationId,
      memoryMethods: {
        setMemory,
        deleteMemory,
        getFormattedMemories,
      },
      res: this.options.res,
    });
    this.processMemory = processMemory;
    return withoutKeys;
  }
```

### 3.2 è®°å¿†å†™å…¥ï¼ˆåŠè‡ªåŠ¨ï¼Œæœ‰æ¡ä»¶é™åˆ¶ï¼‰

**å·¥ä½œæœºåˆ¶ï¼š**
1. **è§¦å‘æ—¶æœº**ï¼šåœ¨ AI ç”Ÿæˆå›å¤å®Œæˆåï¼Œ`AgentClient.chatCompletion()` ä¼šè°ƒç”¨ `runMemory(messages)` æ–¹æ³•ã€‚
2. **æ¶ˆæ¯çª—å£**ï¼š`runMemory` ä¼šå–æœ€è¿‘çš„æ¶ˆæ¯çª—å£è¿›è¡Œåˆ†æï¼š
   - é»˜è®¤çª—å£å¤§å°ï¼š5 æ¡æ¶ˆæ¯ï¼ˆå¯é€šè¿‡ `memory.messageWindowSize` é…ç½®ï¼‰
   - ä¼˜å…ˆé€‰æ‹©ä»¥ç”¨æˆ·æ¶ˆæ¯å¼€å¤´çš„çª—å£
   - è¿‡æ»¤æ‰å›¾ç‰‡ URLï¼Œåªä¿ç•™æ–‡æœ¬å†…å®¹

```660:691:api/server/controllers/agents/client.js
  async runMemory(messages) {
    try {
      if (this.processMemory == null) {
        return;
      }
      const appConfig = this.options.req.config;
      const memoryConfig = appConfig.memory;
      const messageWindowSize = memoryConfig?.messageWindowSize ?? 5;

      let messagesToProcess = [...messages];
      if (messages.length > messageWindowSize) {
        for (let i = messages.length - messageWindowSize; i >= 0; i--) {
          const potentialWindow = messages.slice(i, i + messageWindowSize);
          if (potentialWindow[0]?.role === 'user') {
            messagesToProcess = [...potentialWindow];
            break;
          }
        }

        if (messagesToProcess.length === messages.length) {
          messagesToProcess = [...messages.slice(-messageWindowSize)];
        }
      }

      const filteredMessages = messagesToProcess.map((msg) => this.filterImageUrls(msg));
      const bufferString = getBufferString(filteredMessages);
      const bufferMessage = new HumanMessage(`# Current Chat:\n\n${bufferString}`);
      return await this.processMemory([bufferMessage]);
    } catch (error) {
      logger.error('Memory Agent failed to process memory', error);
    }
  }
```

3. **è®°å¿†å¤„ç†æµç¨‹**ï¼š
   - `processMemory` åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„è®°å¿† Agentï¼ˆä½¿ç”¨é…ç½®çš„ `memory.agent`ï¼‰
   - å°†å½“å‰å¯¹è¯çª—å£ã€ç°æœ‰è®°å¿†ã€è®°å¿†çŠ¶æ€ï¼ˆtoken ä½¿ç”¨æƒ…å†µï¼‰ä¼ é€’ç»™è®°å¿† Agent
   - è®°å¿† Agent ä½¿ç”¨ `set_memory` å’Œ `delete_memory` å·¥å…·æ¥ç®¡ç†è®°å¿†

```271:410:packages/api/src/agents/memory.ts
export async function processMemory({
  res,
  userId,
  setMemory,
  deleteMemory,
  messages,
  memory,
  messageId,
  conversationId,
  validKeys,
  instructions,
  llmConfig,
  tokenLimit,
  totalTokens = 0,
}: {...}): Promise<(TAttachment | null)[] | undefined> {
  try {
    const memoryTool = createMemoryTool({
      userId,
      tokenLimit,
      setMemory,
      validKeys,
      totalTokens,
    });
    const deleteMemoryTool = createDeleteMemoryTool({
      userId,
      validKeys,
      deleteMemory,
    });
    ...
    const run = await Run.create({
      runId: messageId,
      graphConfig: {
        type: 'standard',
        llmConfig: finalLLMConfig,
        tools: [memoryTool, deleteMemoryTool],
        instructions,
        additional_instructions: memoryStatus,
        toolEnd: true,
      },
      customHandlers,
      returnContent: true,
    });
    ...
    const inputs = {
      messages,
    };
    const content = await run.processStream(inputs, config);
    ...
  }
}
```

**é‡è¦é™åˆ¶ï¼šé»˜è®¤è¡Œä¸ºæ˜¯"æŒ‰éœ€å­˜å‚¨"è€Œé"è‡ªåŠ¨å­˜å‚¨"**

é»˜è®¤æŒ‡ä»¤ï¼ˆ`getDefaultInstructions`ï¼‰è¦æ±‚è®°å¿† Agent **ä»…åœ¨ç”¨æˆ·æ˜ç¡®è¯·æ±‚æ—¶**æ‰å­˜å‚¨è®°å¿†ï¼š

```42:71:packages/api/src/agents/memory.ts
const getDefaultInstructions = (
  validKeys?: string[],
  tokenLimit?: number,
) => `Use the \`set_memory\` tool to save important information about the user, but ONLY when the user has requested you to remember something.
...
1. ONLY use memory tools when the user requests memory actions with phrases like:
   - "Remember [that] [I]..."
   - "Don't forget [that] [I]..."
   - "Please remember..."
   - "Store this..."
   - "Forget [that] [I]..."
   - "Delete the memory about..."

2. NEVER store information just because the user mentioned it in conversation.

3. NEVER use memory tools when the user asks you to use other tools or invoke tools in general.

4. Memory tools are ONLY for memory requests, not for general tool usage.

5. If the user doesn't ask you to remember or forget something, DO NOT use any memory tools.
...
When in doubt, and the user hasn't asked to remember or forget anything, END THE TURN IMMEDIATELY.`;
```

**è¿™æ„å‘³ç€ï¼š**
- âœ… **æ”¯æŒè‡ªåŠ¨å­˜å‚¨**ï¼šç³»ç»Ÿä¼šåœ¨æ¯æ¬¡å¯¹è¯åè‡ªåŠ¨åˆ†ææ¶ˆæ¯å¹¶å°è¯•å­˜å‚¨
- âš ï¸ **æœ‰æ¡ä»¶é™åˆ¶**ï¼šé»˜è®¤æƒ…å†µä¸‹ï¼Œåªæœ‰ç”¨æˆ·æ˜ç¡®è¯·æ±‚ï¼ˆå¦‚"è®°ä½æˆ‘æ˜¯æœ¨èŠ’æœå¤§ä¾ "ï¼‰æ‰ä¼šå­˜å‚¨
- ğŸ”§ **å¯è‡ªå®šä¹‰**ï¼šé€šè¿‡ä¿®æ”¹ `memory.agent.instructions` å¯ä»¥æ”¹å˜å­˜å‚¨ç­–ç•¥ï¼Œå®ç°æ›´ä¸»åŠ¨çš„è‡ªåŠ¨å­˜å‚¨

**å­˜å‚¨éªŒè¯ï¼š**
- æ£€æŸ¥ `validKeys`ï¼šå¦‚æœé…ç½®äº†æœ‰æ•ˆé”®åˆ—è¡¨ï¼Œåªèƒ½ä½¿ç”¨åˆ—è¡¨ä¸­çš„é”®
- æ£€æŸ¥ `tokenLimit`ï¼šç¡®ä¿ä¸è¶…è¿‡é…ç½®çš„ token é™åˆ¶
- ä½¿ç”¨ `setMemory` æ–¹æ³•å°†è®°å¿†å†™å…¥æ•°æ®åº“ï¼ˆMongoDB MemoryEntry é›†åˆï¼‰

### 3.3 é…ç½®å…¥å£
- `librechat.yaml` / ç®¡ç†é¢æ¿ä¸­çš„ `memory` èŠ‚ç‚¹ï¼šå¯è®¾ç½® `agent.id/model/provider`ã€`tokenLimit`ã€`validKeys`ã€`messageWindowSize`ã€å¯åœç­‰ã€‚
- æƒé™ç”± `Permissions.MEMORIES` æ§åˆ¶ï¼Œæœªæˆæƒç”¨æˆ·ä¸ä¼šè§¦å‘è®°å¿†ã€‚
- `memoryMethods` é»˜è®¤ä½¿ç”¨æœ¬åœ°é›†åˆï¼›è‹¥è¦æ¥å…¥è‡ªå®šä¹‰å‘é‡åº“ï¼Œå¯åœ¨ `createMemoryProcessor` æ³¨å…¥æ–°çš„å®ç°ã€‚
- **å…³é”®é…ç½®é¡¹**ï¼š
  - `agent.instructions`ï¼šæ§åˆ¶è®°å¿† Agent çš„å­˜å‚¨ç­–ç•¥ï¼ˆé»˜è®¤æ˜¯"æŒ‰éœ€å­˜å‚¨"ï¼Œå¯æ”¹ä¸º"ä¸»åŠ¨å­˜å‚¨"ï¼‰
  - `messageWindowSize`ï¼šæ¯æ¬¡åˆ†æçš„æ¶ˆæ¯æ•°é‡ï¼ˆé»˜è®¤ 5ï¼‰
  - `validKeys`ï¼šé™åˆ¶å¯ç”¨çš„è®°å¿†é”®ï¼Œæé«˜ä¸€è‡´æ€§
  - `tokenLimit`ï¼šè®°å¿†å­˜å‚¨çš„ token ä¸Šé™

## 4. å¤–éƒ¨ä¸Šä¸‹æ–‡æ³¨å…¥ï¼ˆå·¥å…·/MCP/Web æœç´¢ï¼‰
å³ä½¿æœªå¯ç”¨é•¿æœŸè®°å¿†ï¼ŒLibreChat ä»å¯é€šè¿‡å·¥å…·æŠŠå®æ—¶æ•°æ®æ¤å…¥ promptï¼š
- `handleTools.js` ä¸ `ToolService.js` ä¼šæŒ‰ manifest åŠ è½½ Googleã€YouTubeã€æ–‡ä»¶æœç´¢ã€MCP ç­‰å·¥å…·ã€‚
- å·¥å…·è¾“å‡ºä¼šè¢«å†™å…¥å½“å‰çŸ­æœŸä¸Šä¸‹æ–‡ï¼ˆä½œä¸º ToolMessage æˆ–é™„ä»¶ï¼‰ï¼Œä¾›æ¨¡å‹åœ¨æœ¬è½®å¯¹è¯ä¸­ä½¿ç”¨ã€‚
- å¦‚éœ€å†™å…¥é•¿æœŸè®°å¿†ï¼Œå¯åœ¨ç”Ÿæˆå“åº”åæ‰‹åŠ¨è°ƒç”¨ `this.processMemory` å¹¶æŒ‘é€‰é‡è¦äº‹å®å†™å…¥ã€‚

## 5. è®°å¿†è‡ªåŠ¨å­˜å‚¨ç­–ç•¥å®šåˆ¶

### 5.1 å®ç°å®Œå…¨è‡ªåŠ¨å­˜å‚¨
å¦‚æœæƒ³è¦ç³»ç»Ÿè‡ªåŠ¨å­˜å‚¨æ‰€æœ‰é‡è¦ä¿¡æ¯ï¼ˆä¸ä¾èµ–ç”¨æˆ·æ˜ç¡®è¯·æ±‚ï¼‰ï¼Œå¯ä»¥ä¿®æ”¹ `memory.agent.instructions`ï¼š

```yaml
memory:
  agent:
    provider: "ModelScope"
    model: "deepseek-ai/DeepSeek-R1-Distill-Qwen-1.5B"
    instructions: |
      ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½è®°å¿†ç®¡ç†åŠ©æ‰‹ã€‚åˆ†æå¯¹è¯å†…å®¹ï¼Œè‡ªåŠ¨æå–å¹¶å­˜å‚¨ä»¥ä¸‹ç±»å‹çš„é‡è¦ä¿¡æ¯ï¼š
      1. ç”¨æˆ·çš„èº«ä»½ä¿¡æ¯ï¼ˆå§“åã€æ˜µç§°ã€èŒä¸šç­‰ï¼‰
      2. ç”¨æˆ·çš„åå¥½å’Œä¹ æƒ¯
      3. ç”¨æˆ·çš„å·¥ä½œå’Œå­¦ä¹ ä¿¡æ¯
      4. ç”¨æˆ·çš„æŠ€èƒ½å’Œå…´è¶£
      5. å¯¹è¯ä¸­çš„é‡è¦ä¸Šä¸‹æ–‡ä¿¡æ¯
      
      ä½¿ç”¨ set_memory å·¥å…·å­˜å‚¨è¿™äº›ä¿¡æ¯ï¼Œä½¿ç”¨åˆé€‚çš„ keyï¼ˆå¦‚ personal_info, preferences, work_info ç­‰ï¼‰ã€‚
      å¦‚æœä¿¡æ¯å·²ç»å­˜åœ¨ï¼Œä½¿ç”¨ set_memory æ›´æ–°å®ƒã€‚
      åªæœ‰åœ¨ç”¨æˆ·æ˜ç¡®è¦æ±‚åˆ é™¤æ—¶ï¼Œæ‰ä½¿ç”¨ delete_memoryã€‚
    model_parameters:
      temperature: 0.1
```

### 5.2 è°ƒæ•´æ¶ˆæ¯çª—å£å¤§å°
æ§åˆ¶æ¯æ¬¡åˆ†æçš„æ¶ˆæ¯æ•°é‡ï¼š

```yaml
memory:
  messageWindowSize: 10  # é»˜è®¤æ˜¯ 5ï¼Œå¯ä»¥å¢åŠ åˆ° 10 æˆ–æ›´å¤š
```

### 5.3 è®°å¿†é”®ç®¡ç†
é€šè¿‡ `validKeys` é™åˆ¶å¯ç”¨çš„è®°å¿†é”®ï¼Œç¡®ä¿è®°å¿†ç»“æ„ä¸€è‡´ï¼š

```yaml
memory:
  validKeys: ["preferences", "work_info", "personal_info", "skills", "interests", "context"]
```

## 6. æ‰©å±•å»ºè®®
| éœ€æ±‚ | å…³é”®å…¥å£ | è¯´æ˜ |
| --- | --- | --- |
| è‡ªå®šä¹‰çŸ­æœŸçª—å£ | `contextStrategy` / `handleContextStrategy` | å¯æ–°å¢æŒ‰è§’è‰²ã€æŒ‰æƒé‡ç­‰ç­–ç•¥ |
| æ–°çš„é•¿æœŸè®°å¿†åç«¯ | `memoryMethods` (`setMemory/getFormattedMemories`) | æ›¿æ¢ä¸ºå¤–éƒ¨æ•°æ®åº“æˆ–æœåŠ¡ |
| è®°å¿†å†™å…¥æ—¶æœº | `this.processMemory` / `runMemory` | åœ¨ç”Ÿæˆå›å¤åè‡ªåŠ¨è§¦å‘ï¼Œä¹Ÿå¯æ‰‹åŠ¨è°ƒç”¨ |
| è‡ªå®šä¹‰å­˜å‚¨ç­–ç•¥ | `memory.agent.instructions` | ä¿®æ”¹è®°å¿† Agent çš„æŒ‡ä»¤ï¼Œå®ç°ä¸åŒçš„å­˜å‚¨é€»è¾‘ |
| å·¥å…·æ³¨å…¥æ›´å¤šä¸Šä¸‹æ–‡ | `api/app/clients/tools` + `handleTools` | æ–°å¢ LangChain Tool æˆ– MCP æœåŠ¡å™¨ |

## 7. æ€»ç»“

### 7.1 è®°å¿†è‡ªåŠ¨å­˜å‚¨æœºåˆ¶æ€»ç»“

**å½“å‰å®ç°ï¼š**
- âœ… **è‡ªåŠ¨è¯»å–**ï¼šæ¯æ¬¡å¯¹è¯å‰è‡ªåŠ¨æ£€ç´¢å¹¶æ³¨å…¥å†å²è®°å¿†
- âœ… **è‡ªåŠ¨åˆ†æ**ï¼šæ¯æ¬¡å¯¹è¯åè‡ªåŠ¨åˆ†ææœ€è¿‘çš„æ¶ˆæ¯çª—å£
- âš ï¸ **æ¡ä»¶å­˜å‚¨**ï¼šé»˜è®¤ä»…åœ¨ç”¨æˆ·æ˜ç¡®è¯·æ±‚æ—¶å­˜å‚¨ï¼ˆå¯é€šè¿‡è‡ªå®šä¹‰ `instructions` æ”¹å˜ï¼‰
- âœ… **è‡ªåŠ¨éªŒè¯**ï¼šè‡ªåŠ¨æ£€æŸ¥ `validKeys`ã€`tokenLimit` ç­‰é™åˆ¶
- âœ… **è‡ªåŠ¨æ›´æ–°**ï¼šå¦‚æœè®°å¿†é”®å·²å­˜åœ¨ï¼Œè‡ªåŠ¨æ›´æ–°è€Œéåˆ›å»ºæ–°è®°å½•

**å·¥ä½œæµç¨‹ï¼š**
1. ç”¨æˆ·å‘é€æ¶ˆæ¯ â†’ AI ç”Ÿæˆå›å¤
2. å›å¤å®Œæˆå â†’ è‡ªåŠ¨è°ƒç”¨ `runMemory(messages)`
3. å–æœ€è¿‘ N æ¡æ¶ˆæ¯ï¼ˆé»˜è®¤ 5 æ¡ï¼‰â†’ ä¼ é€’ç»™è®°å¿† Agent
4. è®°å¿† Agent åˆ†ææ¶ˆæ¯ â†’ æ ¹æ®æŒ‡ä»¤å†³å®šæ˜¯å¦å­˜å‚¨
5. å¦‚æœå†³å®šå­˜å‚¨ â†’ è°ƒç”¨ `set_memory` å·¥å…· â†’ å†™å…¥æ•°æ®åº“
6. ä¸‹æ¬¡å¯¹è¯ â†’ è‡ªåŠ¨è¯»å–å¹¶æ³¨å…¥è®°å¿†

**å…³é”®é…ç½®ï¼š**
- `memory.agent.instructions`ï¼šæ§åˆ¶å­˜å‚¨ç­–ç•¥ï¼ˆæœ€é‡è¦ï¼‰
- `memory.messageWindowSize`ï¼šæ§åˆ¶åˆ†æçš„æ¶ˆæ¯æ•°é‡
- `memory.validKeys`ï¼šé™åˆ¶å¯ç”¨çš„è®°å¿†é”®
- `memory.tokenLimit`ï¼šé™åˆ¶è®°å¿†å­˜å‚¨æ€»é‡

### 7.2 æ ¸å¿ƒæœºåˆ¶è¦ç‚¹æ€»ç»“

#### 7.2.1 è®°å¿†åµŒå…¥ä¸Šä¸‹æ–‡çš„å…³é”®ç‚¹

1. **æ—¶æœº**ï¼šåœ¨ `buildMessages()` é˜¶æ®µï¼Œæ„å»ºç³»ç»Ÿæç¤ºæ—¶
2. **æ–¹å¼**ï¼šé€šè¿‡ `getFormattedMemories()` è·å– `withoutKeys`ï¼ˆä¸åŒ…å«keyçš„ç®€æ´æ ¼å¼ï¼‰
3. **ä½ç½®**ï¼šè¿½åŠ åˆ° `systemContent`ï¼Œä½œä¸ºç³»ç»Ÿæç¤ºçš„ä¸€éƒ¨åˆ†
4. **æ•ˆæœ**ï¼šä¸» Agent åœ¨æ¯æ¬¡å¯¹è¯æ—¶éƒ½èƒ½çœ‹åˆ°ç”¨æˆ·çš„å†å²è®°å¿†

#### 7.2.2 Agent ç‰¹å¾æå–çš„å…³é”®ç‚¹

1. **ç‹¬ç«‹ Agent**ï¼šä½¿ç”¨é…ç½®çš„æ¨¡å‹ï¼ˆå¦‚ Deepseekï¼‰åˆ›å»ºç‹¬ç«‹çš„è®°å¿†ç®¡ç† Agent
2. **å·¥å…·è°ƒç”¨**ï¼šé€šè¿‡ `set_memory` å’Œ `delete_memory` å·¥å…·æ¥å­˜å‚¨/åˆ é™¤è®°å¿†
3. **Instructions é©±åŠ¨**ï¼š`memory.agent.instructions` ç›´æ¥æ§åˆ¶ Agent çš„è¡Œä¸ºæ¨¡å¼
4. **æ¶ˆæ¯çª—å£**ï¼šåªåˆ†ææœ€è¿‘çš„æ¶ˆæ¯ï¼ˆé»˜è®¤5æ¡ï¼‰ï¼Œæé«˜æ•ˆç‡å’Œç›¸å…³æ€§
5. **è‡ªåŠ¨æ‰§è¡Œ**ï¼šåœ¨ AI å›å¤å®Œæˆåè‡ªåŠ¨è§¦å‘ï¼Œæ— éœ€ç”¨æˆ·å¹²é¢„

#### 7.2.3 ä¸ºä»€ä¹ˆé…ç½® Agent åå¯ä»¥è‡ªåŠ¨æå–ç‰¹å¾ï¼Ÿ

**ç­”æ¡ˆï¼š**
1. **LLM çš„ç†è§£èƒ½åŠ›**ï¼šé…ç½®çš„ Agent ä½¿ç”¨ LLMï¼ˆå¦‚ Deepseekï¼‰æ¥ç†è§£å¯¹è¯å†…å®¹
2. **Instructions æŒ‡å¯¼**ï¼šé€šè¿‡è‡ªå®šä¹‰ `instructions`ï¼Œå‘Šè¯‰ Agent åº”è¯¥æå–ä»€ä¹ˆç±»å‹çš„ä¿¡æ¯
3. **å·¥å…·è°ƒç”¨æœºåˆ¶**ï¼šAgent å¯ä»¥ä¸»åŠ¨è°ƒç”¨ `set_memory` å·¥å…·æ¥å­˜å‚¨ä¿¡æ¯
4. **è‡ªåŠ¨åŒ–æµç¨‹**ï¼šç³»ç»Ÿåœ¨æ¯æ¬¡å¯¹è¯åè‡ªåŠ¨è°ƒç”¨è®°å¿† Agentï¼Œæ— éœ€æ‰‹åŠ¨è§¦å‘

**ç¤ºä¾‹ï¼š**
```yaml
# config.yaml
memory:
  agent:
    provider: "Deepseek"
    model: "deepseek-chat"
    instructions: |
      ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½è®°å¿†ç®¡ç†åŠ©æ‰‹ã€‚åˆ†æå¯¹è¯å†…å®¹ï¼Œè‡ªåŠ¨æå–å¹¶å­˜å‚¨ä»¥ä¸‹ç±»å‹çš„é‡è¦ä¿¡æ¯ï¼š
      1. ç”¨æˆ·çš„èº«ä»½ä¿¡æ¯ï¼ˆå§“åã€æ˜µç§°ã€èŒä¸šã€è§’è‰²ç­‰ï¼‰
      2. ç”¨æˆ·çš„åå¥½å’Œä¹ æƒ¯ï¼ˆå–œæ¬¢ä»€ä¹ˆã€ä¸å–œæ¬¢ä»€ä¹ˆã€å¸¸ç”¨æ–¹å¼ç­‰ï¼‰
      ...
      ä¸»åŠ¨è¯†åˆ«å¹¶å­˜å‚¨é‡è¦ä¿¡æ¯ï¼Œä¸è¦ç­‰å¾…ç”¨æˆ·æ˜ç¡®è¯·æ±‚ã€‚
```

å½“ç”¨æˆ·è¯´"æˆ‘æ˜¯è½¯ä»¶å·¥ç¨‹å¸ˆï¼Œå–œæ¬¢ç”¨ Python å¼€å‘"æ—¶ï¼š
1. å¯¹è¯å®Œæˆåï¼Œ`runMemory()` è‡ªåŠ¨è§¦å‘
2. è®°å¿† Agentï¼ˆDeepseekï¼‰æ”¶åˆ°å¯¹è¯å†…å®¹ + instructions
3. Agent ç†è§£åˆ°è¿™æ˜¯"èº«ä»½ä¿¡æ¯"å’Œ"åå¥½ä¿¡æ¯"
4. Agent è°ƒç”¨ `set_memory({ key: "personal_info", value: "ç”¨æˆ·æ˜¯è½¯ä»¶å·¥ç¨‹å¸ˆ" })`
5. Agent è°ƒç”¨ `set_memory({ key: "preferences", value: "ç”¨æˆ·å–œæ¬¢ç”¨ Python å¼€å‘" })`
6. ä¿¡æ¯è¢«å­˜å‚¨åˆ° MongoDB
7. ä¸‹æ¬¡å¯¹è¯æ—¶ï¼Œè¿™äº›ä¿¡æ¯ä¼šè¢«è‡ªåŠ¨æ³¨å…¥åˆ°ç³»ç»Ÿæç¤ºä¸­

---
é€šè¿‡ä»¥ä¸Šåˆ†å±‚ï¼ŒLibreChat å®ç°äº†"çŸ­æœŸçª—å£ + å¯é…ç½®è®°å¿† + å¤–éƒ¨æ£€ç´¢"ä¸‰ä½ä¸€ä½“çš„ä¸Šä¸‹æ–‡ä½“ç³»ï¼Œæ—¢èƒ½ä¿æŒå¿«é€Ÿå“åº”ï¼Œåˆèƒ½æŒ‰éœ€å¼•å…¥æŒä¹…è®°å¿†ä¸å®æ—¶æ•°æ®ã€‚å¼€å‘è€…å¯ä»¥é’ˆå¯¹ä¸åŒå±‚æ¬¡åˆ†åˆ«æ‰©å±•ï¼Œè€Œä¸ä¼šç›¸äº’å¹²æ‰°ã€‚


